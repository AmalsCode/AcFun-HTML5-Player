var shield=function(){var e,t=/[\x00-\x2f\x3a-\x40\x5b-\x5e\x60\x7b-\x7f]/g,i=!0,o=!0,r=null,n=0,s=!1,l=function(e){return document.querySelector(e)},d=null,a=function(e){return 14==e.length&&"k"==e[3]?!0:"D"==e[0]||"d"==e[0]?!0:"0"==e?!0:!1};return obj={init:function(t){if(i){void 0!=t&&(d=t),i=!1,obj.tab(0),void 0==localStorage.shieldList&&(localStorage.shieldList='{"text":[],"user":[],"color":[],"useReg":false,"limit":10,"mode":[],"visitor":false}'),r=JSON.parse(localStorage.shieldList),void 0==r.color&&(r.color=[]),void 0==r.useReg&&(r.useReg=!1),void 0==r.limit&&(r.limit=10),void 0==r.mode&&(r.mode=[]),void 0==r.visitor&&(r.visitor=!1),s=r.useReg,e=r.limit,obj.render();var o,a,c;for(c=$(".shield_tab"),o=0,a=c.length;a>o;o++)c[o].tabNum=o,c[o].addEventListener("mouseenter",function(){obj.tab(this.tabNum)}),c[o].addEventListener("mouseleave",function(e){var t=this.getBoundingClientRect(),i=e.clientX,o=e.clientY;(i-t.left<0||i-t.left>t.width||o-t.top<0||o-t.top>t.height)&&obj.tab(n)}),c[o].addEventListener("click",function(){obj.switchTab(this.tabNum)});l("#useReg").addEventListener("click",function(){s=!s,obj.save(),obj.render(3)}),l("#blockTop").addEventListener("click",function(){obj.mode(5)}),l("#blockBottom").addEventListener("click",function(){obj.mode(4)}),l("#blockVisitor").addEventListener("click",function(){obj.visitor()});var u=!1,v=function(t){if(u){var i=l("#repeat").getBoundingClientRect(),o=Math.round((t.clientX-i.left)/i.width*49+2);2>o||o>51||(e=o,51==e&&(e=0),obj.render(3))}};l("#repeat").addEventListener("mousedown",function(e){u=!0,v(e)}),l("#repeat").addEventListener("mouseup",function(){u=!1,obj.save()}),l("#repeat").addEventListener("touchend",function(){u=!1,obj.save()}),l(".shield").addEventListener("mousemove",v)}},switchTab:function(e){n=e,l(".shield_body_wrapper").style.transform="translateX("+-278*e+"px)",l(".shield_body_wrapper").style.webkitTransform="translateX("+-278*e+"px)"},tab:function(e){var t=l(".shield"),i=t.getBoundingClientRect(),o=l(".shield .shield_tab:nth-of-type("+(e+1)+")>div").getBoundingClientRect(),r=o.left-i.left,n=o.width,s=l(".shield .shield_tab_slash");s.style.left=r+"px",s.style.width=n+"px"},render:function(t){var i=!0,o=0;for(void 0!=t&&(i=!1,o=t);;){switch(o){case 0:var n,d,a,c="";for(n=0,d=r.text.length;d>n;n++)c+='<div class="shield_item"><div class="text">'+r.text[n]+'</div><div class="delete"></div></div>';for(l("#shield_text").innerHTML=c,a=$("#shield_text .shield_item .delete"),n=0,d=a.length;d>n;n++)a[n].onclick=obj.del;break;case 1:for(var a,c="",n=0;n<r.user.length;n++)c+='<div class="shield_item"><div class="text">'+r.user[n]+'</div><div class="delete"></div></div>';for(0==n&&(c='<div class="shield_item">'+ABP.Strings.blockUserEmpty+"</div>"),l("#shield_user").innerHTML=c,a=$("#shield_user .shield_item .delete"),n=0,d=a.length;d>n;n++)a[n].onclick=obj.delUser;break;case 2:for(var u,a,c="",n=0;n<r.color.length;n++){for(u=r.color[n].toString(16);u.length<6;)u="0"+u;c+='<div class="shield_color"><div class="color" style="background:#'+u+'">'+r.color[n]+'</div><div class="delete"></div></div>'}for(0==n&&(c='<div class="shield_color">'+ABP.Strings.blockColorEmpty+"</div>"),l("#shield_color").innerHTML=c,a=$("#shield_color .shield_color .delete"),n=0,d=a.length;d>n;n++)a[n].onclick=obj.delColor;break;case 3:l("#useReg").className="shield_toggle"+(s?" on":""),l("#blockTop").className="shield_toggle"+(-1!=r.mode.indexOf(5)?" on":""),l("#blockBottom").className="shield_toggle"+(-1!=r.mode.indexOf(4)?" on":""),l("#blockVisitor").className="shield_toggle"+(r.visitor?" on":"");var v=(e-2)/49,h=e+" "+ABP.Strings.repeatPcs;0==e&&(v=1,h=ABP.Strings.repeatUnlimited),l("#repeat .fill").style.width=100*v+"%",l("#repeat .button").style.left=100*v+"%",l("#repeat .slide_info").innerHTML=h;break;default:return}o++}},save:function(){r.useReg=s,r.limit=e,localStorage.shieldList=JSON.stringify(r),obj.shield()},show:function(){o?$(".shield")[0].setAttribute("class","shield"):$(".shield")[0].setAttribute("class","shield hidden"),o=!o},add:function(){obj.addText(l(".shield_item .new").value)&&(l(".shield_item .new").value="")},addText:function(e){if(""==e||-1!=r.text.indexOf(e))return!1;try{s&&new RegExp(e)}catch(e){return d.createPopup("格式错误，"+e.message,3e3),!1}return r.text.push(e),obj.save(),obj.render(0),!0},addUser:function(e){return-1!=r.user.indexOf(e)?!1:(r.user.push(e),obj.save(),void obj.render(1))},addColor:function(e){return e=parseInt(e,16),isNaN(e)||-1!=r.color.indexOf(e)?!1:(r.color.push(e),obj.save(),void obj.render(2))},mode:function(e){var t,i=-1==(t=r.mode.indexOf(e));i?r.mode.push(e):r.mode.splice(t,1),obj.save(),obj.render(3)},visitor:function(){r.visitor=!r.visitor,obj.save(),obj.render(3)},del:function(e){var t,i=e.target.parentNode.firstChild.innerHTML,o=r.text.indexOf(i);return-1==o?!1:(t=r.text.splice(0,o),r.text=t.concat(r.text.splice(1)),obj.save(),void obj.render(0))},delUser:function(e){var t,i=e.target.parentNode.firstChild.innerHTML.split(" ")[0],o=r.user.indexOf(i);return-1==o?!1:(t=r.user.splice(0,o),r.user=t.concat(r.user.splice(1)),obj.save(),void obj.render(1))},delColor:function(e){var t,i=e.target.parentNode.firstChild.innerHTML,o=r.color.indexOf(1*i);return-1==o?!1:(t=r.color.splice(0,o),r.color=t.concat(r.color.splice(1)),obj.save(),void obj.render(2))},filter:function(e){return e.isBlocked?!1:(e.filtered||(e.oriSize=e.size,e.filtered=!0),e.size=e.oriSize*abpinst.commentScale,e)},shield:function(){if(null==d)return!1;var i,o,n=d.cmManager.timeline,l=[],c=0,u=[],v=n.length,h={},f=d.cmManager.runline;if(e>0){for(;v>c;c++)try{l.push(n[c].text.replace(t,""))}catch(e){}for(var b=0,g=b,m={};g!=v;){for(;n[b].stime+1e4<n[g].stime;)0==--m[l[b]]&&delete m[l[b]],++b;void 0==m[l[g]]&&(m[l[g]]=0),++m[l[g]]>e&&n[g].mode<=6&&(h[l[g]]=1),++g}}for(i=0;i<r.text.length;i++)u.push(s?new RegExp(r.text[i]):r.text[i]);for(c=0;v>c;c++)if(o=n[c],o.isBlocked=!1,void 0!=h[l[c]]||-1!=r.color.indexOf(o.color)||-1!=r.user.indexOf(o.hash)||-1!=r.mode.indexOf(o.mode)||r.visitor&&a(o.hash))o.isBlocked=!0;else for(i=0;i<u.length;i++)try{u[i].test(o.text)&&(o.isBlocked=!0)}catch(e){}for(c=f.length-1;c>=0;c--)f[c].originalData.isBlocked&&f[c].finish();d.renderCommentList()}},obj}();window.shield=shield;