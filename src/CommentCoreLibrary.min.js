/*!
 *
 * Comment Core Library CommentManager
 * @license MIT
 * @author Jim Chen
 *
 * Copyright (c) 2014 Jim Chen
 *
 * XMLParsr
 * == Licensed Under the MIT License : /LICENSING
 * Copyright (c) 2012 Jim Chen ( CQZ, Jabbany )
 */
/**
 * Binary Search Stubs for JS Arrays
 * @license MIT
 * @author Jim Chen
 */
/** 
 * Comment Filters Module Simplified (only supports modifiers & types)
 * @license MIT
 * @author Jim Chen
 */
function CommentFilter(){this.modifiers=[],this.runtime=null,this.allowTypes={1:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0},this.doModify=function(t){for(var i=0;i<this.modifiers.length;i++)t=this.modifiers[i](t);return t},this.beforeSend=function(t){return t},this.doValidate=function(t){return this.allowTypes[t.mode]?!0:!1},this.addRule=function(){},this.addModifier=function(t){this.modifiers.push(t)},this.runtimeFilter=function(t){return null==this.runtime?t:this.runtime(t)},this.setRuntimeFilter=function(t){this.runtime=t}}var BinArray=function(){var t={};return t.bsearch=function(t,i,e){if(0===t.length)return 0;if(e(i,t[0])<0)return 0;if(e(i,t[t.length-1])>=0)return t.length;for(var o=0,s=0,n=0,h=t.length-1;h>=o;){if(s=Math.floor((h+o+1)/2),n++,e(i,t[s-1])>=0&&e(i,t[s])<0)return s;e(i,t[s-1])<0?h=s-1:e(i,t[s])>=0?o=s:console.error("Program Error"),n>1500&&console.error("Too many run cycles.")}return-1},t.binsert=function(i,e,o){var s=t.bsearch(i,e,o);return i.splice(s,0,e),s},t}(),__extends=this&&this.__extends||function(t,i){function e(){this.constructor=t}for(var o in i)i.hasOwnProperty(o)&&(t[o]=i[o]);t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)},CommentSpaceAllocator=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this._pools=[[]],this.avoid=1,this._width=t,this._height=i}return t.prototype.willCollide=function(t,i){return t.stime+t.ttl>=i.stime+i.ttl/2},t.prototype.pathCheck=function(t,i,e){for(var o=t+i.height,s=i.right,n=0;n<e.length;n++)if(!(e[n].y>o||e[n].bottom<t)){if(!(e[n].right<i.x||e[n].x>s))return!1;if(this.willCollide(e[n],i))return!1}return!0},t.prototype.assign=function(t,i){for(;this._pools.length<=i;)this._pools.push([]);var e=this._pools[i];if(0===e.length)return t.cindex=i,0;if(this.pathCheck(0,t,e))return t.cindex=i,0;for(var o=0,s=0;s<e.length&&(o=e[s].bottom+this.avoid,!(o+t.height>this._height));s++)if(this.pathCheck(o,t,e))return t.cindex=i,o;return this.assign(t,i+1)},t.prototype.add=function(t){t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,i){return t.bottom<i.bottom?-1:t.bottom>i.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw console.log(t.cindex,t),new Error("cindex out of bounds");var i=this._pools[t.cindex].indexOf(t);0>i||this._pools[t.cindex].splice(i,1)}},t.prototype.setBounds=function(t,i){this._width=t,this._height=i},t}(),AnchorCommentSpaceAllocator=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.add=function(i){t.prototype.add.call(this,i),i.x=(this._width-i.width)/2},i.prototype.willCollide=function(){return!0},i.prototype.pathCheck=function(t,i,e){for(var o=t+i.height,s=0;s<e.length;s++)if(!(e[s].y>o||e[s].bottom<t))return!1;return!0},i}(CommentSpaceAllocator),CoreComment=function(){function t(i,e){if(void 0===e&&(e={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!i)throw new Error("Comment not bound to comment manager.");if(this.parent=i,e.hasOwnProperty("stime")&&(this.stime=e.stime),this.mode=e.hasOwnProperty("mode")?e.mode:1,e.hasOwnProperty("dur")&&(this.dur=e.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,(4===this.mode||5===this.mode)&&(this.dur*=.6,this.ttl*=.6),e.hasOwnProperty("text")&&(this.text=e.text),e.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=e.motion;for(var o=0,s=0;s<e.motion.length;s++){this._motionStart.push(o);var n=0;for(var h in e.motion[s]){var a=e.motion[s][h];n=Math.max(a.dur,n),(null===a.easing||void 0===a.easing)&&(e.motion[s][h].easing=t.LINEAR)}o+=n,this._motionEnd.push(o)}this._curMotion=0}e.hasOwnProperty("color")&&(this._color=e.color),e.hasOwnProperty("size")&&(this._size=e.size),e.hasOwnProperty("border")&&(this._border=e.border),e.hasOwnProperty("opacity")&&(this._alpha=e.opacity),e.hasOwnProperty("alpha")&&(this._alphaMotion=e.alpha),e.hasOwnProperty("font")&&(this._font=e.font),e.hasOwnProperty("x")&&(this._x=e.x),e.hasOwnProperty("y")&&(this._y=e.y),e.hasOwnProperty("shadow")&&(this._shadow=e.shadow),e.hasOwnProperty("position")&&"relative"===e.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){void 0===t&&(t=null),this.dom=null!==t?t.dom:document.createElement("div"),this.dom.className=this.parent.options.global.className,this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this._x=this.align%2===0?this.dom.offsetLeft:this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this._y=this.align<2?this.dom.offsetTop:this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var i=t.toString(16);i=i.length>=6?i:new Array(6-i.length+1).join("0")+i,this.dom.style.color="#"+i,0===this._color&&(this.dom.className=this.parent.options.global.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this.dom.style.border=this._border?"1px solid #00ffff":"none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this.dom.style.fontFamily=this._font.length>0?this._font:""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,i){for(var e in t)if(t.hasOwnProperty(e)){var o=t[e];this[e]=o.easing(Math.min(Math.max(i-o.delay,0),o.dur),o.from,o.to-o.from,o.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),i=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],i),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.stop=function(){},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,i,e,o){return t*e/o+i},t}(),ScrollComment=function(t){function i(i,e){t.call(this,i,e),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(i,t),Object.defineProperty(i.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),i.prototype.init=function(i){void 0===i&&(i=null),t.prototype.init.call(this,i),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},i.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},i}(CoreComment),CSSCompatLayer=function(){function t(){}return t.transform=function(t,i){t.style.transform=i,t.style.webkitTransform=i,t.style.msTransform=i,t.style.oTransform=i},t}(),CSSScrollComment=function(t){function i(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(i,t),Object.defineProperty(i.prototype,"x",{get:function(){return this.ttl/this.dur*(this.parent.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var i=t-this._x;this._x=t,CSSCompatLayer.transform(this.dom,"translateX("+i+"px)")}else this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),i.prototype.update=function(){this._dirtyCSS&&(this.dom.style.transition="transform "+this.ttl+"ms linear",this.x=-this.width,this._dirtyCSS=!1)},i.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},i.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},i}(ScrollComment),CommentManager=function(){function t(t){var i=0,o=this;this._listeners={},this._lastPosition=0,this.stage=t,this.paused=!0,this.pausedTime=0,this.canvas=document.createElement("canvas"),this.canvasStatic=document.createElement("canvas"),this.staticUpdate=!1,this.canvasFPS=0,o.canvas.style.width="100%",o.canvas.style.height="100%",o.stage.appendChild(o.canvas),o.canvasStatic.style.width="100%",o.canvasStatic.style.height="100%",o.canvasStatic.style.position="absolute",o.canvasStatic.style.top=0,o.canvasStatic.style.left=0,o.stage.appendChild(o.canvasStatic),this.options={global:{opacity:1,scale:1,className:"cmt",useCSS:!1,autoOpacity:!1,autoOpacityVal:1},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight;var s=0;this.startTimer=function(){if(!(i>0)){var t=(new Date).getTime(),e=this;i=window.setInterval(function(){var i=(new Date).getTime()-t;t=(new Date).getTime(),e.onTimerEvent(i,e),e.sendQueueLoader()},1e3/60),this.paused=!1,this.pausedTime=Date.now()-s}},this.stopTimer=function(){window.clearInterval(i),i=0,this.paused=!0,s=Date.now()};var n=(this.options.global.opacity,!1),h=0,a=0,r=function(){o.options.global.autoOpacity&&(o.options.global.useCSS?o.stage.style.opacity=e(a):o.options.global.autoOpacityVal=o.options.global.opacity*e(a))};setInterval(function(){o.canvasFPS=h,h=0},1e3),this.addEventListener("enterComment",function(){a++,r()}),this.addEventListener("exitComment",function(){a--,r()}),this.canvasDrawerWrapper=function(t){n||(t||(t=performance.now()),n=!0,h++,o.canvasDrawer(0|t),n=!1)},this.ttlRecalcAll=function(){this.runline.forEach(l)};var d=[];this.send=function(t){d.push(t)},this.sendQueueLoader=function(){for(var t,i=performance.now();d.length>0;)if(o.sendAsync(d.shift()),t=performance.now()-i,t>8)return},this.addEventListener("clear",function(){d=[]}),requestAnimationFrame(this.canvasDrawerWrapper),function(){var t=window.devicePixelRatio;window.addEventListener("resize",function(){var i=window.devicePixelRatio;t!=i&&(o.runline.forEach(function(t){t.textData&&c(t)}),t=i),o.ttlRecalcAll()})}()}var i=function(t,i){for(var e=Math.PI/180,o=t*e,s=i*e,n=Math.cos,h=Math.sin,a=[n(o)*n(s),n(o)*h(s),h(o),0,-h(s),n(s),0,0,-h(o)*n(s),-h(o)*h(s),n(o),0,0,0,0,1],r=0;r<a.length;r++)Math.abs(a[r])<1e-6&&(a[r]=0);return"matrix3d("+a.join(",")+")"},e=function(t){return-Math.tanh((t-50)/25)/Math.PI*.8+.718},o="-apple-system,Arial,'PingFang SC','STHeiti Light','Hiragino Kaku Gothic ProN','Microsoft YaHei'";t.prototype.stop=function(){this.stopTimer();for(var t=0;t<this.runline.length;t++)"undefined"!=typeof this.runline[t].stop&&this.runline[t].stop()},t.prototype.start=function(){this.startTimer()},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,i){return t<i.stime?-1:t>i.stime?1:0})},t.prototype.validate=function(t){return null==t?!1:this.filter.doValidate(t)},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,i){return t.stime>i.stime?2:t.stime<i.stime?-2:t.date>i.date?1:t.date<i.date?-1:null!=t.dbid&&null!=i.dbid?t.dbid>i.dbid?1:t.dbid<i.dbid?-1:0:0}),this.dispatchEvent("load")},t.prototype.insert=function(t){var i=BinArray.binsert(this.timeline,t,function(t,i){return t.stime>i.stime?2:t.stime<i.stime?-2:t.date>i.date?1:t.date<i.date?-1:null!=t.dbid&&null!=i.dbid?t.dbid>i.dbid?1:t.dbid<i.dbid?-1:0:0});i<=this.position&&this.position++,this.dispatchEvent("insert")},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish();this.dispatchEvent("clear"),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvasStatic.getContext("2d").clearRect(0,0,this.canvasStatic.width,this.canvasStatic.height)},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.dispatchEvent("resize");for(var t in this.csa)this.csa[t].setBounds(this.width,this.height);this.stage.style.perspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width*Math.tan(40*Math.PI/180)/2+"px"},t.prototype.init=function(){this.setBounds(),null==this.filter&&(this.filter=new CommentFilter)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this._lastPosition-t)>=2e3){if(this.seek(t),this._lastPosition=t,this.timeline.length<=this.position)return}else this._lastPosition=t;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=t;this.position++)this.options.limit>0&&this.runline.length>this.limiter||this.validate(this.timeline[this.position])&&this.send(this.timeline[this.position])},t.prototype.canvasResize=function(){try{var t=(this.width,this.height,window.devicePixelRatio);this.canvas.width=this.canvas.offsetWidth*t,this.canvasStatic.height=this.canvasStatic.offsetHeight*t,this.ttlRecalcAll(),s(this),n(this)}catch(t){return console.error("shit happened! forcing CSS! ",t.message),void this.useCSS(!0)}};var s=function(t){var i,e,o,s,n=t.canvasStatic,h=n.getContext("2d"),r=window.devicePixelRatio,l=t.height,c=[0];t.runline.forEach(function(t){-1!=[4,5].indexOf(t.mode)&&c.push(t._width)}),c=Math.min(t.width,Math.max.apply(Math,c)),i=c,s=(t.width-c)/2,c!=n.offsetWidth?(n.style.width=c+"px",n.style.left="calc(50% - "+c/2+"px)",n.width=c*r):h.clearRect(0,0,i*r,l*r),h.globalAlpha=t.options.global.autoOpacity?t.options.global.autoOpacityVal:t.options.global.opacity,t.runline.forEach(function(t){if(t.textData){switch(t.mode){case 4:t.x=(i-t.width)/2+s,e=t.x-s,o=l-t.y-t.height;break;case 5:t.x=(i-t.width)/2+s,e=t.x-s,o=t.y;break;default:return}h.drawImage(t.textData,a(e*r),a(o*r))}})},n=function(t){var i,e,o,s=t.canvas,n=s.getContext("2d"),h=window.devicePixelRatio,r=t.width,l=[0];t.runline.forEach(function(t){1==t.mode&&l.push(t._y+t._height)}),l=Math.max.apply(Math,l),i=l,s.offsetHeight!=l?(s.style.height=l+"px",s.height=l*h):n.clearRect(0,0,r*h,i*h),n.globalAlpha=t.options.global.autoOpacity?t.options.global.autoOpacityVal:t.options.global.opacity,t.runline.forEach(function(t){if(t.textData){switch(t.mode){case 1:t.x=r-t.rx,e=r-t.rx,o=t.y;break;default:return}n.drawImage(t.textData,a(e*h),a(o*h))}})};t.prototype.canvasDrawer=function(){if(!this.options.global.useCSS){if(this.paused)return void requestAnimationFrame(this.canvasDrawerWrapper);var t=0|performance.now(),i=window.devicePixelRatio,e=this.pausedTime,o=this.canvas.getContext("2d"),h=this.width,a=this.height;o.clearRect(0,0,h*i,a*i),o.globalAlpha=this.options.global.autoOpacity?this.options.global.autoOpacityVal:this.options.global.opacity,o.imageSmoothingEnabled=!1,0!=e&&(this.runline.forEach(function(t){if(t.textData)switch(t.mode){case 1:t.prev+=e;break;case 4:case 5:t.removeTime+=e}}),this.pausedTime=0),this.runline.forEach(function(i){if(i.textData)switch(i.mode){case 1:i.rx+=i.speed*(t-i.prev)/1e3,i.prev=t}}),this.staticUpdate&&(s(this),this.staticUpdate=!1),n(this),requestAnimationFrame(this.canvasDrawerWrapper)}};var h=Math.ceil,a=Math.round,r=function(t){for(var t=t.toString(16);t.length<6;)t="0"+t;return t},l=function(t){if(t.speed){var i=t.dur-t.ttl;t.dur=(t.parent.width+t.width)/t.speed*1e3,t.ttl=t.dur-i}},c=function(t){var i=document.createElement("canvas"),e=i.getContext("2d"),s=window.devicePixelRatio;e.font=t.size*s+"px "+o,e.imageSmoothingEnabled=!1,t.width=h(e.measureText(t.text).width/s)+2,t.height=h(t.size+3)+2,t.oriWidth=h(t.width*s),t.oriHeight=h(t.height*s),i.width=t.oriWidth,i.height=t.oriHeight,e.font=t.size*s+"px "+o,e.lineWidth=a(1*s),e.strokeStyle=0==t._color?"#FFFFFF":"#000000",e.textBaseline="bottom",e.textAlign="left",e.shadowBlur=a(2*s),e.shadowColor=0==t._color?"#FFFFFF":"#000000",e.fillStyle="#"+r(t.color),e.strokeText(t.text,1,i.height-1),e.fillText(t.text,1,i.height-1),t.border&&(e.lineWidth=a(2*s),e.strokeStyle="#00ffff",e.shadowBlur=0,e.strokeRect(0,0,i.width,i.height)),t.textData=i};return t.prototype.getCommentFromPoint=function(t,i){var e,o,s=[],n=this.height;return this.runline.forEach(function(h){e=t-h.x,o=4==h.mode?i-(n-h.y-h.height):i-h.y,e>=0&&e<=h.width&&o>=0&&o<=h.height&&s.push(h)}),s},t.prototype.useCSS=function(t){this.options.global.useCSS=t,this.clear(),t||(this.stage.style.opacity="",requestAnimationFrame(this.canvasDrawerWrapper))},t.prototype.autoOpacity=function(t){this.options.global.autoOpacity=t},t.prototype.sendAsync=function(t){if(8===t.mode)return console.log(t),void(this.scripting&&console.log(this.scripting.eval(t.code)));if(null==this.filter||(t=this.filter.doModify(t),null!=t&&t!==!1)){if(this.options.global.useCSS||-1==[1,4,5].indexOf(t.mode)){if(1===t.mode||2===t.mode||6===t.mode)var e=new CSSScrollComment(this,t);else var e=new CoreComment(this,t);switch(e.mode){case 1:e.align=0;break;case 2:e.align=2;break;case 4:e.align=2;break;case 5:e.align=0;break;case 6:e.align=1}switch(e.init(),this.stage.appendChild(e.dom),e.dom.transitionStartTime=(new Date).getTime(),e.mode){default:case 1:this.csa.scroll.add(e);break;case 2:this.csa.scrollbtm.add(e);break;case 4:this.csa.bottom.add(e);break;case 5:this.csa.top.add(e);break;case 6:this.csa.reverse.add(e);break;case 17:case 7:(0!==t.rY||0!==t.rZ)&&(e.dom.style.transform=i(t.rY,t.rZ),e.dom.style.webkitTransform=i(t.rY,t.rZ),e.dom.style.OTransform=i(t.rY,t.rZ),e.dom.style.MozTransform=i(t.rY,t.rZ),e.dom.style.MSTransform=i(t.rY,t.rZ))}e.y=e.y}else{var o=performance.now(),e=new CoreComment(this,t);switch(e.dom={style:{}},c(e),1==t.mode||6==t.mode?(e.rx=0,e.x=this.width,e.prev=o,e.speed=(this.width+e.width)/e.dur*1e3):(4==t.mode||5==t.mode)&&(e.removeTime=o+e.dur),e.mode){default:case 1:this.csa.scroll.add(e);break;case 4:this.csa.bottom.add(e),this.staticUpdate=!0;break;case 5:this.csa.top.add(e),this.staticUpdate=!0}}e.originalData=t,this.dispatchEvent("enterComment",e),this.runline.push(e)}},t.prototype.finish=function(t){this.dispatchEvent("exitComment",t);try{this.stage.removeChild(t.dom)}catch(t){}var i=this.runline.indexOf(t);switch(i>=0&&this.runline.splice(i,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t),this.staticUpdate=!0;break;case 5:this.csa.top.remove(t),this.staticUpdate=!0;break;case 6:this.csa.reverse.remove(t);break;case 7:}t.textData&&(t.textData=null)},t.prototype.resumeComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&t.classList.contains("paused")&&(t.style.transitionDuration=t.finalDuration+"ms",t.style.transform=t.finalTransform,t.transitionStartTime=(new Date).getTime(),t.classList.remove("paused"))})},t.prototype.pauseComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&!t.classList.contains("paused")&&(t.finalTransform=t.style.transform,t.style.transform=window.getComputedStyle(t).getPropertyValue("transform"),t.finalDuration=parseFloat(t.style.transitionDuration)-(new Date).getTime()+t.transitionStartTime,t.style.transitionDuration="10ms",t.classList.add("paused"))})},t.prototype.addEventListener=function(t,i){"undefined"!=typeof this._listeners[t]?this._listeners[t].push(i):this._listeners[t]=[i]},t.prototype.dispatchEvent=function(t,i){if("undefined"!=typeof this._listeners[t])for(var e=0;e<this._listeners[t].length;e++)try{this._listeners[t][e](i)}catch(t){console.err(t.stack)}},t.prototype.onTimerEvent=function(t,i){for(var e=0;e<i.runline.length;e++){var o=i.runline[e];o.hold||o.time(t)}},t}();/*end*/